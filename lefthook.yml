---
# Lefthook configuration for git hooks
# Installation: npm install -g @evilmartians/lefthook
# Or: brew install lefthook (macOS)
# Then run: lefthook install

fail_exit_code: 1

# Pre-commit hooks - run before commit
pre-commit:
  # Skip hooks in CI environments
  skip:
    - CI
    - SKIP_LEFTHOOK

  parallel: false
  commands:
    # Secrets scanning - blocks commits containing API keys, passwords, etc.
    secrets-scan:
      priority: 1
      run: |
        # Check if git-secrets is installed
        if ! command -v git-secrets &> /dev/null; then
          echo "âš ï¸  git-secrets not installed. Secrets scanning disabled."
          echo "   Install: brew install git-secrets (macOS)"
          echo "           sudo apt-get install git-secrets (Linux)"
          echo "   See: https://github.com/awslabs/git-secrets"
          echo ""
          echo "   âš ï¸  WARNING: Proceeding without secrets scanning!"
          exit 0
        fi

        # Initialize git-secrets for this repo if not already configured
        if ! git config --local --get-all secrets.patterns &> /dev/null; then
          echo "â„¹ï¸  Initializing git-secrets for this repository..."
          git secrets --install --force
          git secrets --register-aws

          # Add custom patterns
          git secrets --add 'private_key'
          git secrets --add 'api[_-]?key'
          git secrets --add 'api[_-]?secret'
          git secrets --add 'access[_-]?token'
          git secrets --add '[a-zA-Z0-9_-]*password[a-zA-Z0-9_-]*\s*[:=]'
          git secrets --add -- '[-]{5}BEGIN (RSA|DSA|EC|OPENSSH|PGP) PRIVATE KEY'

          echo "âœ… git-secrets patterns registered"
        fi

        # Scan staged files for secrets
        echo "ðŸ” Scanning commit for secrets..."
        git secrets --pre_commit_hook -- "$@"

    # Markdown linting - MD040 and MD060 enforcement
    markdown-lint:
      glob: "*.md"
      run: |
        if ! command -v markdownlint &> /dev/null; then
          echo "â„¹  markdownlint not installed. Skipping detailed checks."
          echo "   Install with: npm install -g markdownlint-cli"
          exit 0
        fi
        markdownlint -c .markdownlint.json {staged_files}
      stage_fixed: true

    # TypeScript/JavaScript linting - if package.json has lint script
    code-lint:
      glob: "*.{js,ts,jsx,tsx}"
      run: |
        if [[ ! -f "package.json" ]]; then
          exit 0
        fi
        if ! grep -q '"lint"' package.json; then
          exit 0
        fi
        npm run lint -- {staged_files}


# Commit message hooks - validate message format
commit-msg:
  commands:
    # Optional: Add commit message validation
    commit-format:
      run: echo "Commit message hook can be extended here"
      skip: true  # Disabled by default

# Post-commit hooks - run after successful commit
post-commit:
  commands:
    # Optional: Post-commit actions
    post-commit-action:
      run: echo "Post-commit hook can be extended here"
      skip: true  # Disabled by default
